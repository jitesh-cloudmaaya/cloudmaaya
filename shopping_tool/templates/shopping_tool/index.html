{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
  <title>Allume - Shopping Tool</title>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css?family=Barlow:100,200,300,400,500,700" rel="stylesheet">
  <!--<link href="{% static 'shopping/css/styles.css' %}" media="all" rel="stylesheet"/>-->
<style>
body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,fieldset,input,textarea,p,blockquote,th,td{margin:0;padding:0;}
table{border-collapse:collapse;border-spacing:0;}
fieldset,img{border:0;}
address,caption,cite,code,dfn,em,th,var{font-style:normal;font-weight:normal;}
ol,ul {list-style:none;}
caption,th {text-align:left;}
h1,h2,h3,h4,h5,h6{font-size:100%;margin:0;letter-spacing:0px;font-weight:normal;}
q:before,q:after{content:'';}
abbr,acronym {border:0;}
select, input, textarea {font:99% arial,helvetica,clean,sans-serif;}
pre, code {font:115% monospace;}
a,a:focus,div:focus,ul:focus,input:focus {outline:0px;}
body {background:#fff; font-size:62.5%;font-family:"Barlow", "Helvetica Neue",Helvetica,Arial,sans-serif;}
html {overflow-y:scroll;overflow-x:auto;}
/* page styles */
#content {
  margin:15px;
  overflow:auto;
}
#search {
  box-sizing: border-box;
  float:left;
  padding-right:15px;
  width:20%
}
#results-wrapper {
  box-sizing: border-box;
  float:left;
  width:80%;
}
a#search-btn {
  background:#f2987e;
  border-radius:3px;
  color:#fff;
  float:right;
  font-size:14px;
  padding:9px 20px;
  margin:0;
  text-decoration: none;
  text-transform: uppercase;
}
a#search-btn:hover {background:#ed8365;}
a#search-btn:active {
  background:#fff;
  box-shadow:inset 0 0 3px rgba(0,0,0,0.3);
  color:#474747;
}
#search label {
  color:#777;
  display:block;
  font-size:14px;
  font-weight:200;
  margin-bottom:10px;

}
input.search {
  background:#fff;
  border:1px solid #d0d0d0;
  border-radius:3px;
  display:block;
  font-size:14px;
  font-weight:200;
  padding:8px;
  width:calc(100% - 130px);
}
#facet-bar {}
#results {overflow:auto; width:100%;}
#results h4 {
  color:#999;
  font-size:40px;
  font-weight:100;
  text-align: center;
  padding:5% 0 0;
}
#results div.item {
  box-shadow: 0 0 2px rgba(34, 25, 25, 0.4);
  float:left;
  margin:5px 7.5px 10px;
  padding:0 0 8px;
  width:calc((100% / 3) - 15px);  
}
#results div.item img {
  display:block;
  height:282px;
  width:282px;
  margin:auto;
}
#results div.item div.image {position:relative;}
#results div.item div.image a.favorite {
  color:#EC407A;
  font-size:28px;
  position:absolute;
  right:15px;
  top:10px;
}
#results div.item span.name {
  background:#fafafa;
  border-bottom:1px solid #eee;
  border-top:1px solid #eee;
  color:#474747;
  display:block;
  font-size:18px;
  font-weight:400;
  margin-bottom:10px;
  padding:15px;
}
#results div.item span.price,
#results div.item span.avail,
#results div.item span.manu {
  color:#474747;
  display:block;
  font-size:16px;
  font-weight:500;
  padding:2px 15px;

}
#results div.item span.avail {float:right; font-weight:200;}
#results div.item span.price em {padding-right:8px;}
#results div.item span.price.strike {color:#D32F2F; text-decoration: line-through;}


#facets {
  border-bottom:1px solid #eee;
  margin-top:20px; 
}
#facets a.facet-group {
  border-top:1px solid #eee;
  color:#474747;
  display:block;
  font-size:14px;
  font-weight:500;
  padding:15px 10px;
  position:relative;
  text-decoration:none;
}
#facets a.facet-group:hover,
#facets a.facet-group.on {background:#fafafa;}
#facets a.facet-group span {
  font-size:26px; 
  font-weight:200;
  line-height:16px;
  overflow:hidden;
  position:absolute;
  right:10px;
  top:12px;
}
#facets a.facet-link {
  color:#474747;
  display:block;
  font-size:12px;
  font-weight:200;
  padding:10px 15px 8px;
  text-decoration:none;
}
#facets a.facet-link em {
  color:#777; 
  float:right;
  font-weight:200; 
  padding-bottom:2px;
}
#facets a.facet-link span {
  border-bottom:2px solid #fff;
  display:inline-block;
  -webkit-transition: all 0.3s ease-in-out;
  transition: all 0.3s ease-in-out;  
  vertical-align: top; 
}

#facets a.facet-link:hover span {border-bottom-color:#474747;}
#facets div.facet-list {display:none;}
#facets div.facet-list label.facet {
  color:#474747;
  display:block;
  font-size:12px;
  font-weight:200;
  padding:10px;
  text-decoration:none;  
}
#facets div.facet-list label.facet input {display:none;}
#facets div.facet-list label.facet span { color: #42A5F5 }
#facets div.facet-list label.facet input + span i.fa-heart {display:none;}
#facets div.facet-list label.facet input:checked + span i.fa-heart-o {display:none;}
#facets div.facet-list label.facet input:checked + span i.fa-heart {display:inline-block;}
#facets div.facet-list label.facet em.key {display:inline-block; margin-left:5px;}
#facets div.facet-list label.facet:hover em.key,
#facets div.facet-list label.facet input:checked + span + em + em.key {color:#42A5F5;}
#facets div.facet-list label.facet em.number { color:#777; float:right; font-weight:200;}



@-webkit-keyframes heartbeat {
  0% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
  14% {
    -moz-transform: rotate(45deg) scale(1.3);
    -ms-transform: rotate(45deg) scale(1.3);
    -webkit-transform: rotate(45deg) scale(1.3);
    transform: rotate(45deg) scale(1.3);
  }
  28% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
  42% {
    -moz-transform: rotate(45deg) scale(1.3);
    -ms-transform: rotate(45deg) scale(1.3);
    -webkit-transform: rotate(45deg) scale(1.3);
    transform: rotate(45deg) scale(1.3);
  }
  70% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
}
@-moz-keyframes heartbeat {
  0% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
  14% {
    -moz-transform: rotate(45deg) scale(1.3);
    -ms-transform: rotate(45deg) scale(1.3);
    -webkit-transform: rotate(45deg) scale(1.3);
    transform: rotate(45deg) scale(1.3);
  }
  28% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
  42% {
    -moz-transform: rotate(45deg) scale(1.3);
    -ms-transform: rotate(45deg) scale(1.3);
    -webkit-transform: rotate(45deg) scale(1.3);
    transform: rotate(45deg) scale(1.3);
  }
  70% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
}
@keyframes heartbeat {
  0% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
  14% {
    -moz-transform: rotate(45deg) scale(1.3);
    -ms-transform: rotate(45deg) scale(1.3);
    -webkit-transform: rotate(45deg) scale(1.3);
    transform: rotate(45deg) scale(1.3);
  }
  28% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
  42% {
    -moz-transform: rotate(45deg) scale(1.3);
    -ms-transform: rotate(45deg) scale(1.3);
    -webkit-transform: rotate(45deg) scale(1.3);
    transform: rotate(45deg) scale(1.3);
  }
  70% {
    -moz-transform: rotate(45deg) scale(1);
    -ms-transform: rotate(45deg) scale(1);
    -webkit-transform: rotate(45deg) scale(1);
    transform: rotate(45deg) scale(1);
  }
}

.pulse_message {
  color:#555;
  font-size:28px;
  font-weight:100;
  line-height:48px;
  padding-left:22px;
}

/* :not(:required) hides this rule from IE9 and below */
.pulse_loader:not(:required) {
  -webkit-animation: heartbeat 1300ms ease 0s infinite normal;
  -moz-animation: heartbeat 1300ms ease 0s infinite normal;
  animation: heartbeat 1300ms ease 0s infinite normal;
  display: inline-block;
  position: relative;
  overflow: hidden;
  text-indent: -9999px;
  width: 36px;
  height: 36px;
  -webkit-transform: rotate(45deg) scale(1);
  transform: rotate(45deg) scale(1);
  -webkit-transform-origin: 50% 50%;
  transform-origin: 50% 50%;
}
.pulse_loader:not(:required):after, .pulse_loader:not(:required):before {
  position: absolute;
  content: "";
  background: #D81B60;
}
.pulse_loader:not(:required):before {
  border-top-left-radius:  12px;
  border-bottom-left-radius: 12px;
  top: 12px;
  left: 0;
  width: 36px;
  height: 24px;
}
.pulse_loader:not(:required):after {
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  top: 0;
  left: 12px;
  width: 24px;
  height: 12px;
}

.pulse_loader.faster:not(:required) {
  -webkit-animation: heartbeat 900ms ease 0s infinite normal;
  -moz-animation: heartbeat 900ms ease 0s infinite normal;
  animation: heartbeat 900ms ease 0s infinite normal;
}
div.loader {padding:10px 20px;}
#pager {overflow:auto; padding:15px 5px; text-align:center;}
#pager a.page,
#pager span.current {
  border-radius:15px;
  color:#474747;
  display:inline-block;
  font-size:13px;
  font-weight:200px;
  height:30px;
  line-height:30px;
  margin:0 2.5px;
  text-align: center;
  text-decoration: none;
  width:30px;
}
#pager span.current {background:#ddd; font-weight:500;}
#pager a.page:hover {background:#eee;}
#pager a.page:active {background-color:#42A5F5; color:#fff;}
#pager a.page.next,
#pager a.page.prev {
  color:#999;
  font-weight: 100;
  position:relative;
  top:-3px;
  width:inherit;
}
#pager a.page.next {float:right;}
#pager a.page.prev {float:left;}
#pager a.page.next:hover,
#pager a.page.prev:hover {background:#fff; color:#777;}
#pager a.page.next:active,
#pager a.page.prev:active {background:#fff; color:#42A5F5; box-shadow: none}
#pager a.page.prev i {position:relative; top:4px; font-size:26px;padding-right:8px;}
#pager a.page.next:active i,
#pager a.page.prev:active i {color:#777;}
#pager a.page.next i {position:relative; top:4px; font-size:26px;padding-left:8px;}
#pager-message {
  color:#777;
  font-size:16px;
  font-weight:100;
  margin:10px 0;
  padding:0 5px;
}
#pager-message strong {font-weight:400;}
a#rack-toggle {
  background:#f2987e;
  border-radius:5px;
  bottom:15px;
  box-shadow:0 1px 2px rgba(0,0,0,0.3);
  color:#fff;
  font-size:18px;
  font-variant: small-caps;
  font-weight:500;
  position:fixed;
  padding:15px 0;
  left:15px;
  text-align: center;
  text-decoration:none;
  width:215px;
  z-index:4;
}
a#rack-toggle span {font-weight:700; padding-right:5px;}
a#rack-toggle:hover {background:#ed8365;}
a#rack-toggle:active{  
  background:#fff;
  box-shadow:inset 0 0 3px rgba(0,0,0,0.3);
  color:#474747;
}
div#rack {
  background:#fff;
  box-shadow:0 0 3px rgba(0,0,0,0.3);
  height:100%;
  left:-515px;
  position:fixed;
  top:0;
  -webkit-transition: all 0.3s ease-in-out;
  transition: all 0.3s ease-in-out;    
  width:500px;
  z-index:5;
}
div#rack.show {left:0;}
div#rack h2 {
  border-bottom:1px solid #eee;
  font-size:18px;
  font-weight:300;
  padding:0 15px;
  height:49px;
  line-height:49px;
}
div#rack-list {
  height:calc(100% - 55px);
  overflow:auto;
}
div#rack-list div.empty {
  color:#777;
  font-size:18px;
  font-weight:300;
  padding:15px;
}
div#rack-list div.item {
  box-shadow: 0 0 2px rgba(34, 25, 25, 0.4);
  margin:15px;
  overflow:auto;
  padding:10px;
  position:relative;
}

div#rack-list div.item div.image { float:left; width:80px;}
div#rack-list div.item div.image img {display:block;margin:auto;}
div#rack-list div.item div.details { float:left; width:(100% - 80px);}
div#rack-list div.item span.name {
  color:#474747;
  display:block;
  font-size:14px;
  font-weight:400;
  padding:0 0 2px;
}
div#rack-list div.item span.price,
div#rack-list div.item span.avail,
div#rack-list div.item span.manu {
  color:#474747;
  display:block;
  font-size:12px;
  font-weight:500;
  padding:2px 0;

}
div#rack-list div.item span.avail {font-weight:200;}
div#rack-list div.item span.price em {padding-right:6px;}
div#rack-list div.item span.price.strike {color:#D32F2F; text-decoration: line-through;}
#close-rack {
  color:#bbb;
  font-size:20px;
  padding:8px 15px;
  position:absolute;
  right:0;
  text-align:center;
  text-decoration: none;
  top:3px;
  -webkit-transition: all 0.3s ease-in-out;
  transition: all 0.3s ease-in-out;  
}
#close-rack:hover {color:#474747;}
#close-rack:active {color:#0090D9;}
a.add-to-rack {
  border:1px solid #ddd;
  border-radius:3px;
  color:#777;
  display:inline-block;
  font-size:11px;
  font-variant:small-caps;
  margin:8px 15px 5px;
  padding:3px 8px 4px;
  text-decoration: none;
  text-transform:lowercase;
}
a.add-to-rack i {font-size:10px; padding-right:4px; position:relative; top:0px;}
a.add-to-rack:hover {
  background:#f7f7f7;
  border-color:#ccc;
  color:#474747;
}
a.add-to-rack:active {
  background:#fff;
  border-color:#fff;
  box-shadow:inset 0 0 3px rgba(0,0,0,0.3);
  color:#474747;
}
a.add-to-rack.selected {
  background:#666;
  box-shadow:inset 0 0 4px rgba(0,0,0,0.5);
  border-color:#666;
  color:#fff;
  text-shadow:0 1px #333;
}
a.remove-from-rack {
  color:#bbb;
  font-size:16px;
  padding:5px 10px;
  position:absolute;
  right:0;
  text-align:center;
  text-decoration: none;
  top:0;
  -webkit-transition: all 0.3s ease-in-out;
  transition: all 0.3s ease-in-out;   
}
a.remove-from-rack:hover {color:#474747;}
a.remove-from-rack:active {color:#0090D9;}
div.already-in-rack {
  position:absolute;
  width:100px;
  z-index:4;
}
div.already-in-rack span.msg {
  background:rgba(0,0,0,0.75);
  border-radius:3px;
  color:#fff;
  display:block;
  font-size:11px;
  font-weight:200;
  padding:5px;
  text-shadow:0 1px #000;
}
div.already-in-rack span.tail {
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 5px solid rgba(0,0,0,0.75);  
  display:block;
  height:0;
  margin-left:45px;
  width:0;
}
</style>
</head>
<body>
<div id="header"></div>
<div id="user-card"></div>
<div id="content">
  <div id="search">
    <label>What are you looking for?</label>
    <a href="#" id="search-btn">show me</a>
    <input class="search" id="search-field" name="text" type="text" placeholder="I want..."/>
    <div id="facets"></div>
  </div>
  <div id="results-wrapper">
    <div id="facet-bar"></div>
    <div id="pager-message"></div>
    <div id="results"></div>
    <div id="pager"></div>
  </div>
</div>
<a id="rack-toggle"><span>0</span> items in your rack</a>
<div id="rack">
  <a href="#" id="close-rack"><i class="fa fa-times"></i></a>
  <h2>My Rack</h2>
  <div id="rack-list">
    <div class="empty">Add items to your rack...</div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
<script>
/**
* @description search_page namespace object, conatining the functionality and templates for the search page
*/
var search_page = {
  /**
  * @description add to rack functionality
  * @param {DOM object} item - link clicked
  */
  addToRack: function(item){
    var rack = $('#rack-list');
    var existing = rack.data('skus');
    var details = item.data('details');
    var idx = item.closest('div.item').index();
    var items = rack.find('div.item').length;
    var add_to_list = false;
    if(existing == undefined){
      item.addClass('selected').html('<i class="fa fa-check"></i> added to rack');
      rack.data('skus', details.sku);
      add_to_list = true;
    }else{
      existing = existing.split(',');
      if(existing.indexOf(details.sku) == -1){
        existing.push(details.sku);
        rack.data('skus', existing.join(','));
        item.addClass('selected').html('<i class="fa fa-check"></i> added to rack');
        add_to_list = true;
      }
    }
    if(add_to_list == true){
      if(items == 0){rack.html('');}
      var desc = details.long_product_description == '' ? details.short_product_description : details.long_product_description ;
      var retail = details.retail_price;
      var sale = details.sale_price;
      var price_display = '';
      if((sale >= retail)||(sale == 0)){
        price_display = '<span class="price"><em>retail price</em>' + numeral(retail).format('$0,0.00') + 
        '</span><span class="price"><em>shipping</em>' + numeral(details.shipping_price).format('$0,0.00') + '</span>';
      }else{
        price_display = '<span class="price strike"><em>retail price</em>' + numeral(retail).format('$0,0.00') + 
        '</span><span class="price"><em>sale price</em>' + numeral(sale).format('$0,0.00') + '</span>' +
        '<span class="price"><em>shipping</em>' + numeral(details.shipping_price).format('$0,0.00') + '</span>';
      }
      rack.append(
        '<div class="item"><a href="#" class="remove-from-rack" data-sku="' + 
        details.sku + '" data-idx="' + idx + '"><i class="fa fa-times"></i></a>' +
        '<div class="image"><img src="' + details.product_image_url + 
        '" style="width:50px"/></div><div class="details">' +
        '<span class="name">' + details.product_name + '</span>' +
        '<span class="manu">' + details.manufacturer_name + '</span>' +
        price_display + '<span class="avail">' + details.availability + 
        '</span></div></div>'
      );
      search_page.updateRackCount();
    }else{
      var pos = item.offset();
      if($('#air-' + idx).length < 1){
        $('body').append(
          '<div class="already-in-rack" id="air-' + idx + 
          '" style="top:' + (pos.top - 32) + 'px;left:' + (pos.left - 37) + 
          'px"><span class="msg">SKU already in rack</span>' +
          '<span class="tail"></span></div>'
        )
        var id = 'air-' + idx;
        window.setTimeout(function(){
          $('#' + id).fadeOut(function(){
            $('#' + id).remove();
          })
        }, 3000)
      }
    }
  },
  /**
  * @description capitalize the first letter of a string
  * @param {string} str - the string to process
  * @returns {string} capitalized first letter of the same string
  */
  capitalizeFirstLetter: function(str){
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  },  
  /**
  * @description capitalize the first letter of every word in a string
  * @param {string} str - the string to process
  * @returns {string} fixed string
  */
  capitalizeEveryWord: function(str){
    return str.replace(/\w\S*/g, function(txt){
      return search_page.capitalizeFirstLetter(txt);
    });
  },
  /**
  * @description make a groups of DOM objects all the same height
  * @params {DOM Array} - array of DOM objects
  */
  equalHeight: function(group) {
    var tallest = 0;
    group.each(function() {
      var thisHeight = $(this).height();
      if(thisHeight > tallest) {
        tallest = thisHeight;
      }
    });
    group.height(tallest);
  },
  /**
  * @description init function applying the functionality to the page elements
  */
  init: function(){
    /* search functionality */
    $('#search-btn').click(function(e){
      e.preventDefault();
      search_page.performSearch(1);
    });
    $("#search-field").keyup(function(event) {
      if (event.keyCode === 13) {
        search_page.performSearch(1);
      }
    });
    /* facets functionality */
    $('#facets').on('click', 'a.facet-group', function(e){
      e.preventDefault();
      var link = $(this);
      if(link.hasClass('on')){
        link.removeClass('on').find('span').html('+');
      }else{
        link.addClass('on').find('span').html('-');
      }
      link.next('div').slideToggle();
    }).on('change','input.facet-box',function(e){
      e.preventDefault();
      var box = $(this);
      console.log(box.prop('checked') + " " + box.val());
      // facet selected box generation goes here also new seacxh initiation
    });
    /* results functionality */
    $('#results').on('click','a.favorite',function(e){
      e.preventDefault();
      var link = $(this);
      if(link.hasClass('favorited')){
        link.removeClass('favorited').find('i').removeClass('fa-heart').addClass('fa-heart-o');
      }else{
        link.addClass('favorited').find('i').removeClass('fa-heart-o').addClass('fa-heart');
      }
      // ajax submission of favoriting will go here
    }).on('click','a.add-to-rack',function(e){
      e.preventDefault();
      var link = $(this);
      search_page.addToRack(link);
    })
    /* pager functionality */
    $('#pager').on('click','a.page',function(e){
      e.preventDefault();
      var link = $(this);
      search_page.performSearch(parseInt(link.data('page')));
    });
    /* my rack functionality */
    $('#rack-toggle').click(function(e){
      e.preventDefault();
      $('#rack').toggleClass('show');
    });
    $('#close-rack').click(function(e){
      e.preventDefault();
      $('#rack').removeClass('show');
    });
    $('#rack-list').on('click','a.remove-from-rack',function(e){
      e.preventDefault();
      var link = $(this);
      var sku = link.data('sku');
      var rack = $('#rack-list');
      var existing = rack.data('skus').split(',');
      var idx = existing.indexOf(sku);
      existing.splice(idx,1);
      rack.data('skus',existing.join(','));
      link.closest('div.item').remove();
      /* undo selected btn */
      var list_entry = $('#results div.item').eq(link.data('idx'));
      var add_link = list_entry.find('a.add-to-rack');
      var link_sku = add_link.data('details').sku;
      if(link_sku == sku){
        add_link.html('<i class="fa fa-plus-circle"></i>add to rack').removeClass('selected');
      }
      search_page.updateRackCount();
    });
  },
  /**
  * @description processing and template for facets
  * @param {object} facets - the facets object
  */
  facetTemplate: function(facets){
    var markup = [];
    if(facets != undefined){
      /* build initial list of facet buckets */
      var buckets = Object.keys(facets).sort();
      for(var i = 0, l = buckets.length; i<l; i++){
        var bucket = buckets[i];
        var facet_list = facets[bucket];
        var display_name = bucket.replace('_filter_', '');
        markup.push(
          '<a href="#" class="facet-group"><span>+</span>' + 
          search_page.capitalizeEveryWord(display_name.replace(/_/g, ' ')) + 
          '</a><div class="facet-list" data-qparam="' + display_name + '">'
        );
        facet_list[display_name].buckets.sort(function(a,b){
          if(a.key.toLowerCase() > b.key.toLowerCase()){ return 1}
          if(a.key.toLowerCase() < b.key.toLowerCase()){ return -1}
          return 0;
        })
        for(var j = 0, num = facet_list[display_name].buckets.length; j<num; j++){
          var facet = facet_list[display_name].buckets[j];
          if(facet.key != ''){
            markup.push(
              '<label class="facet">' +
              '<input class="facet-box" type="checkbox" value="' + 
              facet.key + '"/><span>' +
              '<i class="fa fa-heart-o"></i>' +
              '<i class="fa fa-heart"></i>' +
              '</span><em class="number">' + 
              numeral(facet.doc_count).format('0,0') +
              '</em><em class="key">' + facet.key + '</em></label>'
            );
          }
        }
        markup.push('</div>');
      }
      $('#facets').html(markup.join(''));
    }    
  },
  /**
  * @description processing and template for pagination of results
  * @param {integer} page - page currently displayed
  * @param {integer} total - total number of items in result set
  * @param {integer} per_page - number of items per page payload
  */  
  pagerTemplate: function(page, total, per_page){
    var markup = [];
    var total_pages = Math.floor(total / per_page);
    var excess = total % per_page;
    if(excess > 0){ total_pages++};
    /* create pager message string */
    var showing_low = numeral(((page * per_page) - per_page + 1)).format('0,0');
    var showing_high = numeral(page * per_page).format('0,0');
    var result_total = numeral(total).format('0,0');
    $('#pager-message').html(
      'Showing <strong>' + showing_low + '</strong> - <strong>' + 
      showing_high + '</strong> of <strong>' + result_total + '</strong>'
    );
    /**
    * @description private function to gerenate links
    * @param {integer} page - current page
    * @param {integer} low - low number to use in loop
    * @param {integer} high - high number to use in loop
    * @returns {string} HTML
    */        
    function makePager(page, low, high){
      var pager = [];
      for(var i = (page - low); i < (page + high); i++){
        if(i > 0){        
          if(i == page){
            pager.push('<span class="current">' + i + '</span>');
          }else{
            if(i <= total_pages){
              pager.push('<a href="#" data-page="' + i + '" class="page">' + i + '</a>');
            }
          }
        }
      }
      return pager.join('');
    }
    if(page > 1){
      markup.push(
        '<a href="#" data-page="' + (page - 1) + 
        '" class="page prev"><i class="fa fa-angle-left"></i>Previous</a>'
      );
    }
    if(total_pages > page){
      markup.push(
        '<a href="#" data-page="' + (page + 1) + 
        '" class="page next">Next<i class="fa fa-angle-right"></i></a>'
      );
    }
    if((page > 3)&&(page <= (total_pages - 3))){
      markup.push(
        '<a href="#" data-page="1" class="page">1</a>' +
        '<span class="break">...</span>' +
        makePager(page, 1, 2)
      );
      if((page + 2) < total_pages){
        markup.push(
          '<span class="break">...</span>' +
          '<a href="#" data-page="' + total_pages + '" class="page">' + total_pages + '</a>'
        )          
      }
    }else{
      var show_max_ellipse = false;
      if(page == 1){
        var max = total_pages > 5 ? 4 : 5;
        markup.push(
          makePager(page, 2, max)
        );
        if((page + max) < total_pages){ show_max_ellipse = true }
      }else if(page == 2){
        var max = total_pages > 5 ? 3 : 4;
        markup.push(
          makePager(page, 1, max)
        );  
        if((page + max) < total_pages){ show_max_ellipse = true }              
      }else if(page == 3){
        var max = total_pages > 5 ? 2 : 3;
        markup.push(
          makePager(page, 2, max)
        );
        if((page + max) < total_pages){ show_max_ellipse = true } 
      }else if(page == total_pages){
        var min = 2; 
        if(total_pages > 5){ min = 3 }else if(total_pages <= 5){ min = 4}; 
        if((page - min) > 2 ){
          markup.push(
            '<a href="#" data-page="1" class="page">1</a>' +
            '<span class="break">...</span>'
          );
        } 
        markup.push(
          makePager(page, min , 2)
        );       
      }else if(page == (total_pages - 1)){
        var min = 3; 
        if(total_pages > 5){ min = 2 }else if(total_pages <= 5){ min = 3}; 
        if((page - min) > 2 ){
          markup.push(
            '<a href="#" data-page="1" class="page">1</a>' +
            '<span class="break">...</span>'
          );
        } 
        markup.push(
          makePager(page, min , 2)
        );       
      }else if(page == (total_pages - 2)){
        var min = 4; 
        if(total_pages > 5){ min = 1 }else if(total_pages <= 5){ min = 2}; 
        if((page - min) > 2 ){
          markup.push(
            '<a href="#" data-page="1" class="page">1</a>' +
            '<span class="break">...</span>'
          );
        } 
        markup.push(
          makePager(page, min , 3)
        );       
      }
      if(show_max_ellipse == true){
        markup.push(
          '<span class="break">...</span>' +
          '<a href="#" data-page="' + total_pages + '" class="page">' + total_pages + '</a>'
        );
      }
    }
    $('#pager').html(markup.join(''));
  },
  /**
  * @description ajax call to get search results
  * @param {integer} page - the page to fetch
  */
  performSearch: function(page){
    /* generate the query string */
    var q = '';
    var text = $('#search-field').val();
    if(text != '') { q += 'text=' + text; }
    var facets = [];
    $.each($('#facets div.facet-list'), function(idx){
      var list = $(this);
      var selected = list.find('input:checked');
      if(selected.length > 0){
        var values = selected.map(function (i, facet){ return facet.value }).get();
        facets.push(
          '&' + list.data('qparam') + '=' + values.join(',')
        );
      }
    });
    q += '&page=' + page;
    $.ajax({
      beforeSend: function(){
        $('#results').html(
          '<div class="loader">' +
          '<span class="pulse_loader"></span>' +
          '<span class="pulse_message">Finding things you\'ll love...</span>' +
          '</div>'
        );
        $('#pager-message').html('');
        $('#pager').html('');
      },
      type: "GET",
      url: '/product_api/facets?',
      data: q,
      success: function(results){
        console.log(results)
        search_page.pagerTemplate(results.page, results.total_items, results.num_per_page);
        search_page.resultTemplate(results.data);
        search_page.facetTemplate(results.facets);
      }
    });
  },
  /**
  * @description processing and template for product results
  * @param {array} results - the product result array
  */  
  resultTemplate: function(results){
    var w = $('#results').width() / 3
    var dynamic_dim = 'style="height:' + w + 'px;"'
    var markup = [];
    if(results != undefined && results.length > 0){
      for(var i = 0, l = results.length; i<l; i++){
        var item = results[i];
        var details = item._source;
        var desc = details.long_product_description == '' ? details.short_product_description : details.long_product_description ;
        var retail = details.retail_price;
        var sale = details.sale_price;
        var price_display = '';
        if((sale >= retail)||(sale == 0)){
          price_display = '<span class="price"><em>retail price</em>' + numeral(retail).format('$0,0.00') + 
          '</span><span class="price"><em>shipping</em>' + numeral(details.shipping_price).format('$0,0.00') + '</span>';
        }else{
          price_display = '<span class="price strike"><em>retail price</em>' + numeral(retail).format('$0,0.00') + 
          '</span><span class="price"><em>sale price</em>' + numeral(sale).format('$0,0.00') + '</span>' +
          '<span class="price"><em>shipping</em>' + numeral(details.shipping_price).format('$0,0.00') + '</span>';
        }
        markup.push(
          '<div class="item"><div class="image"><a href="#" class="favorite">' +
          '<i class="fa fa-heart-o"></i></a><img src="' + 
          details.product_image_url + '" ' + dynamic_dim + 
          '></div><span class="name">' + details.product_name + 
          '</span><span class="avail">' + details.availability + '</span>' + 
          '<span class="manu">' + details.manufacturer_name + '</span>' +
          price_display + '<a href="#" class="add-to-rack">' +
          '<i class="fa fa-plus-circle"></i>add to rack</a></div>'
        );
      }
      $('#results').html(markup.join(''));
      if(markup.length > 0){
        var items = $('#results div.item');
        for(var i = 0, l = results.length; i<l; i++){
          var item = results[i];
          var details = item._source;   
          items.eq(i).find('a.add-to-rack').data('details',details);       
        }
      }
      search_page.equalHeight($('#results div.item'));
    }
  },
  /**
  * @description update the rack toggle button display
  */
  updateRackCount: function(){
    var items = $('#rack-list div.item').length;
    var s = items == 1 ? '' : 's';
    $('#rack-toggle').html('<span>' + items + '</span> item' + s + ' in your rack');
  }
}
/* call the search page init function to set up the page */
search_page.init();
</script>
</body>
</html>
